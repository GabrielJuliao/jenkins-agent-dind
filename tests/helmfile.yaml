repositories:
  # - name: ingress-nginx
  #   url: https://kubernetes.github.io/ingress-nginx
  - name: jenkins
    url: https://charts.jenkins.io

helmDefaults:
  wait: true
  waitForJobs: true

releases:
  # TODO: Make K3D ingress work
  # - name: ingress-nginx
  #   chart: ingress-nginx/ingress-nginx
  #   version: 4.3.0
  #   namespace: ingress-nginx
  #   createNamespace: true

  - # https://github.com/jenkinsci/helm-charts/tree/main/charts/jenkins
    name: jenkins
    chart: jenkins/jenkins
    version: 4.2.15
    # needs:
    #   - ingress-nginx/ingress-nginx
    values:
      - agent:
          image: ghcr.io/felipecrs/jenkins-agent-dind
          tag: latest
          alwaysPullImage: true
          privileged: true
          args: ""
        controller:
          adminPassword: "admin"
          # jenkinsUriPrefix: "/jenkins"
          # ingress:
          #   enabled: true
          additionalPlugins:
            - job-dsl:1.81
            - docker-workflow:528.v7c193a_0b_e67c
          JCasC:
            configScripts:
              jobs: |
                jobs:
                  - script: >
                      pipelineJob('test-agent') {
                        definition {
                          cps {
                            sandbox()
                            script("""\
                              pipeline {
                                agent any
                                stages {
                                  stage ('docker') {
                                    steps {
                                      sh 'docker version'
                                    }
                                  }
                                  stage ('docker on docker') {
                                    agent {
                                      docker {
                                        reuseNode true
                                        image 'felipecrs/fixdockergid:latest'
                                        args '--mount=source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind --group-add=docker'
                                      }
                                    }
                                    steps {
                                      sh 'docker version'
                                    }
                                  }
                                }
                              }
                              """.stripIndent())
                          }
                        }
                      }
        persistence:
          enabled: true
